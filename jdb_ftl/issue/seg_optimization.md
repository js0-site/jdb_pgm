# Seg 描述符优化分析

## 背景

用户提出将 12 字节 `Seg` 描述符优化为 8 字节以减少元数据开销。

## 当前实现

```rust
// src/ftl/seg/mod.rs
#[repr(C, align(4))]
pub struct Seg {
  pub w0: u32,  // Base[0..31]
  pub w1: u32,  // Base[32..47] | Bit-Offset[0..15]
  pub w2: u32,  // Bit-Offset[16..19] | Slope[0..21] | Width[0..5]
}
```

| 字段       | 位宽                   | 用途                            |
| ---------- | ---------------------- | ------------------------------- |
| Base       | 48 bits                | PGM 线性预测基准值              |
| Bit-Offset | 20 bits                | 残差数据在 Payload 中的字节偏移 |
| Slope      | 22 bits                | 定点斜率 (×2²⁴)                 |
| Width      | 6 bits                 | 残差位宽 (0-63)                 |
| **总计**   | **96 bits = 12 bytes** |                                 |

## 8 字节优化可行性分析

### 硬需求

- Base (48b) + Slope (22b) + Width (6b) = **76 bits**
- 64 bits (8 bytes) **不够**

### 唯一压缩路径

移除 `bit_offset` 字段 (20 bits)：

| 方案                 | 大小                     | 变化 | 代价                     |
| -------------------- | ------------------------ | ---- | ------------------------ |
| 移除 bit_offset      | 76b → 80b = **10 bytes** | -2B  | 随机查询 O(1)→O(N)       |
| 再压缩 slope 22b→10b | 64b = **8 bytes**        | -4B  | 拟合精度损失 + O(N) 查询 |

## 关键发现：文档与代码不一致

### 文档描述 (`readme/zh/codec.md` §2.1)
> "放弃在分段描述符中存储显式的偏移量 (Offset)"

### 实际代码

```rust
// encode.rs:221 - 编码时显式存储
let seg = Seg::new(f.base, f.slope, bit_offset_val, f.bit_width);

// decode.rs:54 - 解码时直接读取
let byte_offset = seg.bit_offset() as usize;
```

**结论**：`bit_offset` 被**显式存储**并**直接使用**，文档描述与代码实现不符。

## 显式存储的优势

| 场景          | 显式存储 (当前) | 隐式推导          |
| ------------- | --------------- | ----------------- |
| 单点 LBA 查询 | O(1) ✅          | O(N) 需遍历前序段 |
| 批量解码      | O(N)            | O(N)              |
| 空间代价      | 每段 +20 bits   | 节省 20 bits      |

FTL 以**单点查询**为主，O(1) 随机访问是核心需求。

## 建议

### 选项 1：保持现状 ⭐ 推荐

- 保留 12 字节 + 显式 `bit_offset`
- 修正文档，如实描述"显式存储"设计
- 理由：单点查询 O(1) 性能优先，空间代价极小 (~10B/组)

### 选项 2：移除 bit_offset (10 字节)

- 修改 3 个解码器改为累积计算
- 接受单点查询性能下降 O(1)→O(N)
- 适用场景：批量解码为主，极致压缩优先

### 选项 3：激进压缩 (8 字节)

- 选项 2 + slope 精度从 22b 降至 10b
- 风险：非线性数据拟合质量下降
- 不推荐：收益小，风险大

## 已完成修复

- [x] 修复 `encode.rs:273-274` 重复累加 `current_cursor` 的 bug
- [ ] 待定：是否修正文档与代码一致性

---

*Generated: 2026-01-20*
